:scrollbar:
:data-uri:
:toc2:
:imagesdir: images

= Upgrading RHEL 7 to 8 with LEAPP and BOOM - LTO Show & Tell Series

== Description
This Show&Tell is aimed to share some of the most important concepts and actions needed for upgrading a RHEL 7 to RHEL 8.

Audience: IT Managers, Architects, IT security specialists and technical staff who operates Linux

:numbered:

== Introduction

This Show & Tell is intended to give system administrators information about leapp as a tool for assiting in the upgrading fromn RHEL 7 to RHEL 8 instances, with the minimal effort but with maximum security and a very short downtime window.

== Understand the environment and evaluate the pre-requisites.

An in-place upgrade is a recommended and supported way for migrating your system to the next major version of RHEL. This applies to RHEL 6 to RHEL 7 or RHEL 7 to RHEL 8 instances.

=== Applications

We need to understand, at first, the environment in terms of the applications installed. This is a very important step, mainly because after the upgrading process some packages and libraries will be depracated or changed in versions. Applications need to be analyzed under the light of what thay use of the operating system to run properly. Leapp pre-upgrade report is a good source of this kind of information, allowing the possibility to match the running application requierements with the possible changes the OS will experiment. In case of changes impacting the application, we need to take actions on this, that could go from modifying the application to install a new version of it.

=== Operating system and HW considerations.

Take a look of the https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/upgrading_from_rhel_7_to_rhel_8/index#planning-an-upgrade_upgrading-from-rhel-7-to-rhel-8[requierements] needed to be considered for prepare the environment for the upgrading.

== Preparing a RHEL 7 system for the upgrade

=== Check instance is subscribed

Ensure the system is registered, if not you can use subscription-manager to do so.

[source,bash]
-----------------------------------------
subscription-manager register --auto-attach
-----------------------------------------

=== Check the current version and release of the running instance.

[source,bash]
-----------------------------------------
subscription-manager list --installed
+-------------------------------------------+
    Installed Product Status
+-------------------------------------------+
Product Name:   Red Hat Enterprise Linux Server
Product ID:     69
Version:        7.8
Arch:           x86_64
Status:         Not Subscribed
Status Details:
Starts:
Ends:
-----------------------------------------

In this example the version is 7.8 which is the last minor version of RHEL 7, at the moment this article was writen. In case we are not in the last minor version, we need to update the RHEL instance appropiately.

In some cases customers lock the updates to a specific versions. In this case we need to instruct the Subscription Manager to consume the latest content.

[source,bash]
-----------------------------------------
subscription-manager release --unset
yum versionlock clear
-----------------------------------------

=== Add the proper repositories

[source,bash]
-----------------------------------------
subscription-manager repos --enable rhel-7-server-rpms -enable rhel-7-server-extras-rpms
-----------------------------------------

=== Update the instance

Run yum to update the instance to the lasted update.

[source,bash]
-----------------------------------------
yum update
-----------------------------------------

=== Install LEAPP utility

Leapp is an OS and application modernization framework. In this case leapp is used for upgrading the OS from RHEL 7 to RHEL 8.

[source,bash]
-----------------------------------------
yum install leapp leapp-repository
-----------------------------------------

At this point we need to download additional required data files attached to the Knowledgebase https://access.redhat.com/articles/3664871[article] Data required by the Leapp utility for an in-place upgrade from RHEL 7 to RHEL 8 and place them in the /etc/leapp/files/ directory. This is necessary for a successful upgrade. Note that currently you need data files from the *leapp-data8.tar.gz* archive or later.

*NOTE:* we need to download the file *leapp-data8.tar.gz* using a browser, then uncompress it on  /etc/leapp/files

[source,bash]
-----------------------------------------
tar -xzf leapp-data8.tar.gz -C /etc/leapp/files && rm leapp-data8.tar.gz
-----------------------------------------

=== GRUB Considerations

If GRUB is installed outside of the default location, which is /boot, export the respective environment variable as follows:

[source,bash]
-----------------------------------------
export LEAPP_GRUB_DEVICE="/path_to_device"
-----------------------------------------

=== Automated tools considerations

Ensure you have any configuration management (such as Salt, Chef, Puppet, Ansible) disabled or adequately reconfigured to not attempt to restore the original RHEL 7 system.

=== Network Considerations

Ensure your system does not use more than one Network Interface Card (NIC) with a name based on the prefix used by the kernel *(eth)*.

=== Backup & Recovery Considerations

Ensure you have a full system backup or a virtual machine snapshot. you can use the https://access.redhat.com/solutions/2115051[Relax-and-Recover (ReaR) utility]. Alternatively, you can use https://www.redhat.com/en/blog/upgrading-rhel-7-rhel-8-leapp-and-boom[LVM snapshots using Boom], or RAID splitting.

== Pre-Upgrade reporting

Customers always can execute a pre-upgrade procedure that will analyze the instance and will create a report that can be visualized on text format. Alternatively customers can install webconsole on the server and the plugin for leapp. This will allow the customer to see a color coded  and easier to read report. Also from Webconsole they can execute the remediations leapp can advice in the pre-upgrade analysis.

[source,bash]
-----------------------------------------
yum install cockpit cockpit-leapp
sysmtemctl enable --now cockpit.socket
-----------------------------------------

Then access the service using the server's ip and the port 9090 from any browser.

=== Executing the pre-upgrade analysis

After all components are installed and everything is configured correctly we are ready to generate the first report that exposes the analysis of leapp over the instance.

[source,bash]
-----------------------------------------
leapp preupgrade --debug

==> Processing phase `configuration_phase`
====> * ipu_workflow_config
        IPU workflow config actor
==> Processing phase `FactsCollection`
====> * scan_custom_repofile
        Scan the custom /etc/leapp/files/leapp_upgrade_repositories.repo repo file.
====> * network_manager_read_config
        Provides data about NetworkManager configuration.
====> * tcp_wrappers_config_read
        Parse tcp_wrappers configuration files /etc/hosts.{allow,deny}.
====> * system_facts
        Provides data about many facts from system.

...

==> Processing phase `Reports`
====> * verify_check_results
        Check all dialogs and notify that user needs to make some choices.
====> * verify_check_results
        Check all generated results messages and notify user about them.

============================================================
                     UPGRADE INHIBITED
============================================================

Upgrade has been inhibited due to the following problems:
    1. Inhibitor: Possible problems with remote login using root account
Consult the pre-upgrade report for details and possible remediation.

============================================================
                     UPGRADE INHIBITED
============================================================


Debug output written to /var/log/leapp/leapp-preupgrade.log

============================================================
                           REPORT
============================================================

A report has been generated at /var/log/leapp/leapp-report.json
A report has been generated at /var/log/leapp/leapp-report.txt

============================================================
                       END OF REPORT
============================================================

Answerfile has been generated at /var/log/leapp/answerfile
-----------------------------------------

As you can see in the output for this test environment there is one inhibitor.

*Upgrade has been inhibited due to the following problems:
    1. Inhibitor: Possible problems with remote login using root account. Consult the pre-upgrade report for details and possible remediation.*

There are a lot of inrmation in the report that we will be showing with webconsole. For now we need to understand how to fix the inhibition to proceed with the upgrade process.

[source,bash]
-----------------------------------------
cat /var/log/leapp/leapp-report.txt

... output omited for space sake!

Risk Factor: high (inhibitor)
Title: Possible problems with remote login using root account
Summary: OpenSSH configuration file does not explicitly state the option PermitRootLogin in sshd_config file, whi
ch will default in RHEL8 to "prohibit-password".
Remediation: [hint] If you depend on remote root logins using passwords, consider setting up a different user for
 remote administration or adding "PermitRootLogin yes" to sshd_config.

... output omited for space sake!
-----------------------------------------

As we can see, we need to explicitly permit root login on this instance. Doing it it is very straighforward.

[source,bash]
-----------------------------------------
vim /etc/ssh/sshd_config

.... uncomment the line
#PermitRootLogin yes
-----------------------------------------

=== The report from webconsole

The report can be accessed using a webconsole plugin called cockpit-leapp with conveniently show a color coded report with more detailed information in a human readible format.

image::leapp_webconsole_report.png[]

A color code and some values can give us enough information about leapp findings.

* Risk factor
** High - very likely to result in a deteriorated system state
** Medium - can impact both the system and applications
** Low - should not impact the system but can have an impact on applications

* Inhibitor - will inhibit (hard stop) the upgrade process, otherwise the system could become unbootable, inaccessible, or dysfunctional

* Remediation - an actionable solution to a reported problem:
** Remediation command - can be executed directly through the web console
** Remediation hint - instructions on how to resolve the problem manually

In this report, a remediation hint is proposed for the inhibitor rule, which is uncomment "PermitRootLogin yes", as described above.

This report can be seen as a pre-flight check, where valuable information is listed for taken actions on applications tunning on the system.

In this report, for example, we can see in the first two lines that some packages are not going to be installed on the upgraded instance.We can check which packages are not going to be installed just clicking on the links, as you can see in the next image.



== Ready for Upgradino RHEL

=== Phase 1

After all pre-requisites are met and all remediation hints are applied, we are ready to execute leapp for upgrading the RHEL instance.


[source,bash]
-----------------------------------------
leapp upgrade

==> Processing phase `configuration_phase`
====> * ipu_workflow_config
        IPU workflow config actor
==> Processing phase `FactsCollection`
====> * scan_custom_repofile
        Scan the custom /etc/leapp/files/leapp_upgrade_repositories.repo repo file.
====> * network_manager_read_config
        Provides data about NetworkManager configuration.
====> * transaction_workarounds
        Provides additional RPM transaction tasks based on bundled RPM packages.
====> * tcp_wrappers_config_read
        Parse tcp_wrappers configuration files /etc/hosts.{allow,deny}.
====> * system_facts
        Provides data about many facts from system.
====> * rpm_scanner
        Provides data about installed RPM Packages.

... output omited for space sake!

[SKIPPED] dbus-1.12.8-10.el8_2.x86_64.rpm: Already downloaded
[SKIPPED] grub2-tools-minimal-2.02-87.el8_2.x86_64.rpm: Already downloaded
[SKIPPED] grub2-tools-2.02-87.el8_2.x86_64.rpm: Already downloaded
[SKIPPED] grub2-common-2.02-87.el8_2.noarch.rpm: Already downloaded
[SKIPPED] ca-certificates-2020.2.41-80.0.el8_2.noarch.rpm: Already downloaded
(193/843): perl-Time-HiRes-1.9758-1.el8.x86_64.  52 kB/s |  61 kB     00:01
(194/843): udisks2-iscsi-2.8.3-2.el8.x86_64.rpm  32 kB/s |  46 kB     00:01
(195/843): udisks2-lvm2-2.8.3-2.el8.x86_64.rpm   44 kB/s |  70 kB     00:01
(196/843): libudisks2-2.8.3-2.el8.x86_64.rpm    104 kB/s | 140 kB     00:01
(197/843): redhat-support-lib-python-0.11.2-1.e  83 kB/s | 229 kB     00:02
(198/843): redhat-support-tool-0.11.2-2.el8.noa 120 kB/s | 236 kB     00:01

... output omited for space sake!

--------------------------------------------------------------------------------
Total                                           409 kB/s | 555 MB     23:08
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                        1/1
Complete!
The downloaded packages were saved in cache until the next successful transaction.
You can remove cached packages by executing 'dnf clean packages'.
==> Processing phase `InterimPreparation`
====> * initram_disk_generator
        Creates the upgrade initram disk
====> * add_upgrade_boot_entry
        Add new boot entry for Leapp provided initramfs.
====> * efi_interim_fix
        Adjust EFI boot entry for first reboot
A reboot is required to continue. Please reboot your system.


Debug output written to /var/log/leapp/leapp-upgrade.log

============================================================
                           REPORT
============================================================

A report has been generated at /var/log/leapp/leapp-report.json
A report has been generated at /var/log/leapp/leapp-report.txt

============================================================
                       END OF REPORT
============================================================
-----------------------------------------


== Upgrading process
